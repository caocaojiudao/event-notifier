<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Notifier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .settings-btn {
            background: #764ba2;
        }

        .settings-btn:hover {
            background: #663a91;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .event-source {
            display: inline-block;
            background: #f0f0f0;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .event-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.95em;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            font-weight: bold;
            color: #667eea;
        }

        .event-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .event-link:hover {
            color: #764ba2;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .no-events {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .no-events h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .no-events p {
            color: #666;
            font-size: 1.1em;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            color: #999;
            font-size: 1.5em;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 50%;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .source-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .source-info a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* Discovery UI styles */
        .discover-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .discover-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #663a91 100%);
        }

        .university-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .university-item:hover {
            border-color: #667eea;
            background: #f8f8ff;
        }

        .university-item.added {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .university-details h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .university-meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .university-distance {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .add-btn {
            background: #4caf50;
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .add-btn:hover {
            background: #45a049;
        }

        .add-btn.added {
            background: #666;
        }

        .remove-btn {
            background: #f44336;
            padding: 8px 20px;
            font-size: 0.9em;
        }

        .remove-btn:hover {
            background: #da190b;
        }

        .location-prompt {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .location-prompt button {
            margin-top: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Filter Panel Styles */
        .filter-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .filter-header h3 {
            color: #667eea;
            margin: 0;
            font-size: 1.2em;
        }

        .filter-toggle {
            font-size: 1.5em;
            color: #667eea;
            transition: transform 0.3s;
        }

        .filter-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .filter-content {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-content.hidden {
            display: none;
        }

        .filter-section {
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 15px;
        }

        .filter-section h4 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .filter-option label {
            cursor: pointer;
            font-size: 0.95em;
            color: #555;
        }

        .filter-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .clear-filters-btn {
            background: #f44336;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .clear-filters-btn:hover {
            background: #da190b;
        }

        .filter-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .events-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Event Notifier</h1>
            <p class="subtitle">Discover upcoming events from top universities</p>
        </header>

        <div class="controls">
            <div class="info">
                <div class="info-item">
                    <span>üìÖ Events:</span>
                    <span class="badge" id="event-count">0</span>
                </div>
                <div class="info-item">
                    <span>üîÑ Last Update:</span>
                    <span id="last-update">Never</span>
                </div>
                <div class="info-item">
                    <span>üì° Sources:</span>
                    <span class="badge" id="source-count">0</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openDiscovery()" class="discover-btn">üîç Discover Nearby</button>
                <button onclick="refreshEvents()" id="refresh-btn">üîÑ Refresh Now</button>
                <button onclick="openSettings()" class="settings-btn">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <!-- Filter Panel -->
        <div id="filter-panel" class="filter-panel" style="display: none;">
            <div class="filter-header" onclick="toggleFilters()">
                <h3>üîç Filter Events <span id="active-filters-count" class="filter-count" style="display: none;">0</span></h3>
                <span class="filter-toggle">‚ñº</span>
            </div>
            <div class="filter-content" id="filter-content">
                <div class="filter-section">
                    <h4>üè∑Ô∏è Tags</h4>
                    <div id="tag-filters" class="filter-options">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="filter-section">
                    <h4>üìç Source</h4>
                    <div id="source-filters" class="filter-options">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="filter-actions" id="filter-actions" style="display: none;">
                <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
                <button onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>

        <div id="events-container" class="loading">
            Loading events...
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Event Sources</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Enable or disable event sources:</p>
            <div id="sources-list"></div>
        </div>
    </div>

    <!-- Discovery Modal -->
    <div id="discovery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Discover Universities</h2>
                <button class="close-btn" onclick="closeDiscovery()">√ó</button>
            </div>

            <!-- Tab Buttons -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('nearby')">Nearby</button>
                <button class="tab-btn" onclick="switchTab('all')">All Universities</button>
                <button class="tab-btn" onclick="switchTab('search')">Search</button>
            </div>

            <!-- Nearby Tab -->
            <div id="nearby-tab" class="tab-content active">
                <div id="location-prompt" class="location-prompt">
                    <h3>üìç Find Events Near You</h3>
                    <p>Allow location access to discover university events in your area</p>
                    <button onclick="requestLocation()">üìç Share Location</button>
                </div>
                <div id="nearby-universities" style="display: none;">
                    <p style="color: #666; margin-bottom: 15px;">
                        <strong id="nearby-count">0</strong> universities found within <strong id="nearby-radius">100</strong> miles
                    </p>
                    <div id="nearby-list"></div>
                </div>
            </div>

            <!-- All Universities Tab -->
            <div id="all-tab" class="tab-content">
                <p style="color: #666; margin-bottom: 15px;">Browse all <strong id="total-count">0</strong> universities:</p>
                <div id="all-list"></div>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content">
                <input type="text" class="search-box" id="search-input" placeholder="Search by name, city, or state..." oninput="searchUniversities()">
                <div id="search-results"></div>
            </div>
        </div>
    </div>

    <script>
        let events = [];
        let scrapers = [];
        let allEvents = []; // Store unfiltered events
        let activeFilters = {
            tags: new Set(),
            sources: new Set()
        };
        let cachedFilterOptions = null; // Cache filter options to avoid regenerating

        // Load events on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            loadScrapers();
        });

        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                const data = await response.json();

                allEvents = data.events || [];
                events = allEvents; // Initially show all events

                document.getElementById('event-count').textContent = events.length;
                document.getElementById('source-count').textContent = data.sources || 0;

                if (data.lastUpdate) {
                    const date = new Date(data.lastUpdate);
                    document.getElementById('last-update').textContent = date.toLocaleString();
                }

                // Show filter panel if we have events
                if (allEvents.length > 0) {
                    document.getElementById('filter-panel').style.display = 'block';
                    document.getElementById('filter-actions').style.display = 'flex'; // Show buttons
                    // Only populate filters if options have changed
                    if (shouldUpdateFilters()) {
                        populateFilters();
                    }
                } else {
                    document.getElementById('filter-panel').style.display = 'none';
                }

                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('events-container').innerHTML = `
                    <div class="no-events">
                        <h2>Error Loading Events</h2>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        async function loadScrapers() {
            try {
                const response = await fetch('/api/scrapers');
                scrapers = await response.json();
            } catch (error) {
                console.error('Error loading scrapers:', error);
            }
        }

        function renderEvents() {
            const container = document.getElementById('events-container');

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="no-events">
                        <h2>No Events Found</h2>
                        <p>Check back later or try refreshing to scrape for new events.</p>
                    </div>
                `;
                return;
            }

            container.className = 'events-grid';
            container.innerHTML = events.map(event => `
                <div class="event-card">
                    <div class="event-source">${event.source}</div>
                    <h3 class="event-title">${event.title}</h3>
                    <div class="event-meta">
                        <div class="meta-item">
                            <span class="icon">üìÖ</span>
                            <span>${formatDate(event.date)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="icon">üìç</span>
                            <span>${event.location}</span>
                        </div>
                    </div>
                    ${event.description ? `<p class="event-description">${event.description}</p>` : ''}
                    <a href="${event.link}" target="_blank" class="event-link">View Details ‚Üí</a>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
            const timeStr = date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });

            if (diffDays === 0) return `Today at ${timeStr}`;
            if (diffDays === 1) return `Tomorrow at ${timeStr}`;
            if (diffDays > 0 && diffDays <= 7) return `${dateStr} at ${timeStr}`;
            return `${dateStr} at ${timeStr}`;
        }

        async function refreshEvents() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Refreshing...';

            try {
                await fetch('/api/scrape', { method: 'POST' });
                await loadEvents();
                btn.textContent = '‚úì Refreshed!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Now';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error refreshing:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh Now';
                    btn.disabled = false;
                }, 2000);
            }
        }

        function openSettings() {
            renderScrapers();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function renderScrapers() {
            const container = document.getElementById('sources-list');
            container.innerHTML = scrapers.map(scraper => `
                <div class="source-item">
                    <div class="source-info">
                        <h3>${scraper.name}</h3>
                        <a href="${scraper.url}" target="_blank">${scraper.url}</a>
                    </div>
                    <div class="toggle-switch ${scraper.active ? 'active' : ''}"
                         onclick="toggleScraper('${scraper.id}', ${!scraper.active})">
                    </div>
                </div>
            `).join('');
        }

        async function toggleScraper(id, enabled) {
            try {
                await fetch(`/api/scrapers/${id}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                await loadScrapers();
                renderScrapers();
            } catch (error) {
                console.error('Error toggling scraper:', error);
            }
        }

        // Close modal when clicking outside
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') {
                closeSettings();
            }
        });

        // Discovery Functions

        let currentTab = 'nearby';
        let allUniversities = [];
        let nearbyUniversities = [];
        let addedUniversities = new Set();

        function openDiscovery() {
            loadAllUniversities();
            document.getElementById('discovery-modal').classList.add('active');
        }

        function closeDiscovery() {
            document.getElementById('discovery-modal').classList.remove('active');
        }

        function switchTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tab}-tab`).classList.add('active');

            // Load data for tab
            if (tab === 'all' && allUniversities.length === 0) {
                loadAllUniversities();
            }
        }

        async function requestLocation() {
            const prompt = document.getElementById('location-prompt');
            prompt.innerHTML = '<p>üîÑ Getting your location...</p>';

            if (!navigator.geolocation) {
                prompt.innerHTML = '<p>‚ùå Geolocation is not supported by your browser</p>';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    await findNearby(latitude, longitude);
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    prompt.innerHTML = `
                        <p>‚ùå Could not get your location</p>
                        <p style="font-size: 0.9em; color: #999;">${error.message}</p>
                        <button onclick="requestLocation()">Try Again</button>
                    `;
                }
            );
        }

        async function findNearby(lat, lng, radius = 100) {
            try {
                const response = await fetch('/api/discover/nearby', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat, lng, radius })
                });

                const data = await response.json();

                if (data.success) {
                    nearbyUniversities = data.universities;
                    document.getElementById('nearby-count').textContent = data.count;
                    document.getElementById('nearby-radius').textContent = radius;
                    document.getElementById('location-prompt').style.display = 'none';
                    document.getElementById('nearby-universities').style.display = 'block';
                    renderUniversities(nearbyUniversities, 'nearby-list');
                }
            } catch (error) {
                console.error('Error finding nearby universities:', error);
            }
        }

        async function loadAllUniversities() {
            try {
                const response = await fetch('/api/discover/all');
                const data = await response.json();

                if (data.success) {
                    allUniversities = data.universities;
                    document.getElementById('total-count').textContent = data.count;
                    renderUniversities(allUniversities, 'all-list');
                }
            } catch (error) {
                console.error('Error loading universities:', error);
            }
        }

        async function searchUniversities() {
            const query = document.getElementById('search-input').value;

            if (!query || query.length < 2) {
                document.getElementById('search-results').innerHTML = '<p style="color: #999;">Enter at least 2 characters to search</p>';
                return;
            }

            try {
                const response = await fetch(`/api/discover/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success) {
                    renderUniversities(data.universities, 'search-results');
                }
            } catch (error) {
                console.error('Error searching universities:', error);
            }
        }

        function renderUniversities(universities, containerId) {
            const container = document.getElementById(containerId);

            if (universities.length === 0) {
                container.innerHTML = '<p style="color: #999;">No universities found</p>';
                return;
            }

            container.innerHTML = universities.map(uni => {
                const isAdded = scrapers.some(s => s.id === uni.id);
                const distanceHtml = uni.distance !== null ?
                    `<span class="university-distance">${uni.distance} miles</span>` : '';

                return `
                    <div class="university-item ${isAdded ? 'added' : ''}">
                        <div class="university-details">
                            <h3>${uni.name}</h3>
                            <div class="university-meta">
                                üìç ${uni.city}, ${uni.state} ${distanceHtml}
                            </div>
                            <a href="${uni.calendarUrl}" target="_blank" style="color: #667eea; font-size: 0.85em;">${uni.calendarUrl}</a>
                        </div>
                        <button
                            class="${isAdded ? 'remove-btn' : 'add-btn'}"
                            onclick="${isAdded ? `removeUniversity('${uni.id}')` : `addUniversity('${uni.id}')`}">
                            ${isAdded ? '‚úì Added' : '+ Add'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function addUniversity(id) {
            try {
                const response = await fetch(`/api/discover/add/${id}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload scrapers to get the new one
                    await loadScrapers();

                    // Re-render current view
                    if (currentTab === 'nearby') {
                        renderUniversities(nearbyUniversities, 'nearby-list');
                    } else if (currentTab === 'all') {
                        renderUniversities(allUniversities, 'all-list');
                    } else {
                        searchUniversities();
                    }

                    // Show success feedback
                    console.log('University added successfully');
                }
            } catch (error) {
                console.error('Error adding university:', error);
            }
        }

        async function removeUniversity(id) {
            try {
                const response = await fetch(`/api/discover/remove/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload scrapers
                    await loadScrapers();

                    // Re-render current view
                    if (currentTab === 'nearby') {
                        renderUniversities(nearbyUniversities, 'nearby-list');
                    } else if (currentTab === 'all') {
                        renderUniversities(allUniversities, 'all-list');
                    } else {
                        searchUniversities();
                    }

                    console.log('University removed successfully');
                }
            } catch (error) {
                console.error('Error removing university:', error);
            }
        }

        // Close discovery modal when clicking outside
        document.getElementById('discovery-modal').addEventListener('click', (e) => {
            if (e.target.id === 'discovery-modal') {
                closeDiscovery();
            }
        });

        // Filter Functions

        function toggleFilters() {
            const content = document.getElementById('filter-content');
            const actions = document.getElementById('filter-actions');
            const toggle = document.querySelector('.filter-toggle');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                actions.style.display = 'flex';
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('hidden');
                actions.style.display = 'none';
                toggle.classList.add('collapsed');
            }
        }

        function shouldUpdateFilters() {
            // Extract current filter options from events
            const tags = new Set();
            const sources = new Set();

            allEvents.forEach(event => {
                if (event.tags && Array.isArray(event.tags)) {
                    event.tags.forEach(tag => {
                        if (tag) tags.add(tag);
                    });
                }
                if (event.source) sources.add(event.source);
            });

            // Create a string representation for comparison
            const currentOptions = JSON.stringify({
                tags: Array.from(tags).sort(),
                sources: Array.from(sources).sort()
            });

            // Check if options have changed
            if (cachedFilterOptions === currentOptions) {
                return false; // No change, don't update
            }

            cachedFilterOptions = currentOptions;
            return true; // Options changed, update needed
        }

        function populateFilters() {
            const tags = new Set();
            const sources = new Set();

            // Extract unique values from all events (optimized single pass)
            for (const event of allEvents) {
                if (event.tags && Array.isArray(event.tags)) {
                    for (const tag of event.tags) {
                        if (tag) tags.add(tag);
                    }
                }
                if (event.source) sources.add(event.source);
            }

            // Populate tag filters
            const tagContainer = document.getElementById('tag-filters');
            if (tags.size > 0) {
                const sortedTags = Array.from(tags).sort();
                // Use innerHTML for simplicity - only called when filters actually change
                tagContainer.innerHTML = sortedTags.map(tag =>
                    `<div class="filter-option">
                        <input type="checkbox" id="tag-${sanitizeId(tag)}" value="${tag}" onchange="updateFilters()">
                        <label for="tag-${sanitizeId(tag)}">${tag}</label>
                    </div>`
                ).join('');
            } else {
                tagContainer.innerHTML = '<p style="color: #999; font-size: 0.9em;">No tags available</p>';
            }

            // Populate source filters
            const sourceContainer = document.getElementById('source-filters');
            if (sources.size > 0) {
                const sortedSources = Array.from(sources).sort();
                sourceContainer.innerHTML = sortedSources.map(source =>
                    `<div class="filter-option">
                        <input type="checkbox" id="source-${sanitizeId(source)}" value="${source}" onchange="updateFilters()">
                        <label for="source-${sanitizeId(source)}">${source}</label>
                    </div>`
                ).join('');
            } else {
                sourceContainer.innerHTML = '<p style="color: #999; font-size: 0.9em;">No sources available</p>';
            }
        }

        function sanitizeId(str) {
            return str.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        }

        function updateFilters() {
            // Collect selected filters
            activeFilters.tags.clear();
            activeFilters.sources.clear();

            document.querySelectorAll('#tag-filters input:checked').forEach(cb => {
                activeFilters.tags.add(cb.value);
            });

            document.querySelectorAll('#source-filters input:checked').forEach(cb => {
                activeFilters.sources.add(cb.value);
            });

            // Update filter count badge
            const totalFilters = activeFilters.tags.size + activeFilters.sources.size;
            const countBadge = document.getElementById('active-filters-count');

            if (totalFilters > 0) {
                countBadge.textContent = totalFilters;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        function applyFilters() {
            if (activeFilters.tags.size === 0 && activeFilters.sources.size === 0) {
                // No filters selected, show all events
                events = allEvents;
            } else {
                // Optimized filtering with early returns
                const hasTagFilter = activeFilters.tags.size > 0;
                const hasSourceFilter = activeFilters.sources.size > 0;

                events = allEvents.filter(event => {
                    // Check source first (faster lookup)
                    if (hasSourceFilter) {
                        if (!event.source || !activeFilters.sources.has(event.source)) {
                            return false;
                        }
                    }

                    // Check tags
                    if (hasTagFilter) {
                        if (!event.tags || !Array.isArray(event.tags)) {
                            return false;
                        }
                        // Use some() with early termination
                        if (!event.tags.some(tag => activeFilters.tags.has(tag))) {
                            return false;
                        }
                    }

                    return true;
                });
            }

            document.getElementById('event-count').textContent = events.length;
            renderEvents();
        }

        function clearFilters() {
            // Uncheck all checkboxes
            document.querySelectorAll('#tag-filters input, #source-filters input').forEach(cb => {
                cb.checked = false;
            });

            // Clear active filters
            activeFilters.tags.clear();
            activeFilters.sources.clear();

            // Hide badge
            document.getElementById('active-filters-count').style.display = 'none';

            // Show all events
            events = allEvents;
            document.getElementById('event-count').textContent = events.length;
            renderEvents();
        }
    </script>
</body>
</html>
